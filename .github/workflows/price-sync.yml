name: Sync ETF Prices

on:
  # Run every 15 minutes during market hours (9:30 AM - 4:15 PM ET)
  # Times in UTC using EDT (Mar-Nov), will be 1 hour off during EST (Nov-Mar)
  # Market hours: 9:30 AM - 4:00 PM ET, with final fetch at 4:15 PM for closing prices
  schedule:
    - cron: '30,45 13 * * 1-5'    # 9:30 AM, 9:45 AM EDT (market open)
    - cron: '*/15 14-19 * * 1-5'  # Every 15 min: 10:00 AM - 3:45 PM EDT
    - cron: '0,15 20 * * 1-5'     # 4:00 PM, 4:15 PM EDT (market close + final fetch)

  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  sync-prices:
    runs-on: ubuntu-latest

    steps:
      - name: Sync ETF prices from Finnhub
        run: |
          echo "üîÑ Triggering price refresh..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://401k.mreedon.com/api/prices/refresh \
            -H "X-401K-Token: ${{ secrets.API_SHARED_TOKEN }}" \
            -H "Content-Type: application/json")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -ne 200 ]; then
            echo "‚ùå Price sync failed with status $http_code"
            exit 1
          fi

          echo "‚úÖ Price sync completed successfully"
