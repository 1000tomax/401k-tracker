name: Daily Portfolio Snapshot

on:
  # Run daily BEFORE first ETF price sync (before market open) for PREVIOUS day
  # This gives Plaid overnight to sync all of yesterday's transactions
  # Process flow: Sync Plaid ‚Üí Fetch prices ‚Üí Create snapshot for yesterday
  # 13:00 UTC = 9:00 AM EDT / 8:00 AM EST (always before 9:30 AM market open)
  schedule:
    - cron: '0 13 * * 2-6'  # Tue-Sat at 9:00 AM EDT / 8:00 AM EST (creates Mon-Fri snapshots)

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      date:
        description: 'Snapshot date (YYYY-MM-DD, optional - defaults to today)'
        required: false
        type: string

jobs:
  create-snapshot:
    runs-on: ubuntu-latest

    steps:
      - name: Sync Plaid transactions
        run: |
          echo "üîÑ Syncing Plaid transactions (overnight sync ensures all yesterday's trades captured)..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://401k.mreedon.com/api/sync/transactions \
            -H "X-401K-Token: ${{ secrets.API_SHARED_TOKEN }}" \
            -H "Content-Type: application/json" \
            --connect-timeout 10 \
            --max-time 60)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "HTTP Status: $http_code"

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Plaid sync completed"
            # Extract summary if available
            json_line=$(echo "$body" | grep -o '{.*}' | tail -n1)
            if [ -n "$json_line" ]; then
              formatted_summary=$(echo "$json_line" | jq -r '.formatted_summary // empty' 2>/dev/null)
              if [ -n "$formatted_summary" ]; then
                echo "$formatted_summary"
              fi
            fi
          else
            echo "‚ö†Ô∏è Plaid sync failed with status $http_code, continuing anyway"
            echo "Response: $body"
            # Don't fail workflow - snapshot uses yesterday's date, transactions already in DB
          fi

      - name: Sync dividend rates from Tiingo
        run: |
          echo "üíé Syncing dividend per-share rates from Tiingo (last 90 days)..."

          # Calculate date range (last 90 days)
          from_date=$(date -u -d '90 days ago' '+%Y-%m-%d')
          to_date=$(date -u '+%Y-%m-%d')

          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://401k.mreedon.com/api/dividends/sync-rates-tiingo \
            -H "X-401K-Token: ${{ secrets.API_SHARED_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"fromDate\": \"$from_date\", \"toDate\": \"$to_date\"}")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Dividend rates synced successfully"
            # Extract summary if available
            matched=$(echo "$body" | jq -r '.results.matched // 0' 2>/dev/null)
            updated=$(echo "$body" | jq -r '.results.updated // 0' 2>/dev/null)
            if [ -n "$matched" ] && [ "$matched" != "0" ]; then
              echo "üìä Matched $matched dividends, updated $updated records with Tiingo rates"
            fi
          else
            echo "‚ö†Ô∏è Dividend sync failed with status $http_code, continuing anyway (non-critical)"
            # Don't fail the workflow - calculated rates are still available
          fi

      - name: Fetch closing prices
        run: |
          echo "üí∞ Fetching closing prices from Finnhub (forced)..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://401k.mreedon.com/api/prices/refresh \
            -H "X-401K-Token: ${{ secrets.API_SHARED_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"force": true}')

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -ne 200 ]; then
            echo "‚ùå Price fetch failed with status $http_code"
            exit 1
          fi

          echo "‚úÖ Closing prices fetched successfully"

      - name: Wait for database to settle
        run: |
          echo "‚è≥ Waiting 5 seconds for prices to propagate..."
          sleep 5

      - name: Create daily portfolio snapshot
        run: |
          echo "üì∏ Creating portfolio snapshot for yesterday..."

          # Calculate yesterday's date (snapshot is for previous day)
          if [ -n "${{ github.event.inputs.date }}" ]; then
            snapshot_date="${{ github.event.inputs.date }}"
          else
            snapshot_date=$(date -u -d 'yesterday' '+%Y-%m-%d')
          fi

          echo "Snapshot date: $snapshot_date"
          body="{\"date\": \"$snapshot_date\", \"source\": \"github-actions\"}"

          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://401k.mreedon.com/api/snapshots/save \
            -H "X-401K-Token: ${{ secrets.API_SHARED_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$body")

          http_code=$(echo "$response" | tail -n1)
          body_response=$(echo "$response" | head -n-1)

          echo "Response: $body_response"
          echo "HTTP Status: $http_code"

          # Check if successful (200) or already exists (409)
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Snapshot created successfully"
            echo "$body_response" | jq -r '.snapshot | "Date: \(.date)\nMarket Value: $\(.marketValue)\nGain/Loss: $\(.gainLoss) (\(.gainLossPercent)%)\nHoldings: \(.holdingsCount)"'
          elif [ "$http_code" -eq 409 ]; then
            echo "‚ÑπÔ∏è Snapshot already exists for today"
          else
            echo "‚ùå Snapshot creation failed with status $http_code"
            exit 1
          fi

      - name: Send transaction summary email
        run: |
          echo "üìß Sending transaction summary email..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://401k.mreedon.com/api/emails/send-transaction-summary \
            -H "X-401K-Token: ${{ secrets.API_SHARED_TOKEN }}" \
            -H "Content-Type: application/json")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Transaction email sent successfully"
          else
            echo "‚ö†Ô∏è Email failed with status $http_code, but continuing (non-critical)"
            # Don't fail the workflow if email fails
          fi
