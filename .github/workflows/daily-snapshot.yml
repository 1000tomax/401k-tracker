name: Daily Portfolio Snapshot

on:
  # Run daily at 4:05 PM ET (after market close)
  # End-of-day processing: Sync Plaid ‚Üí Fetch prices ‚Üí Create snapshot
  # 20:05 UTC = 4:05 PM ET
  schedule:
    - cron: '5 20 * * 1-5'  # Mon-Fri at 4:05 PM ET

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      date:
        description: 'Snapshot date (YYYY-MM-DD, optional - defaults to today)'
        required: false
        type: string

jobs:
  create-snapshot:
    runs-on: ubuntu-latest

    steps:
      - name: Sync Plaid transactions
        run: |
          echo "üîÑ Syncing Plaid transactions (optimistic - may catch same-day trades)..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://401k.mreedon.com/api/sync/transactions \
            -H "X-401K-Token: ${{ secrets.API_SHARED_TOKEN }}" \
            -H "Content-Type: application/json" \
            --connect-timeout 10 \
            --max-time 60)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "HTTP Status: $http_code"

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Plaid sync completed"
            # Extract summary if available
            json_line=$(echo "$body" | grep -o '{.*}' | tail -n1)
            if [ -n "$json_line" ]; then
              formatted_summary=$(echo "$json_line" | jq -r '.formatted_summary // empty' 2>/dev/null)
              if [ -n "$formatted_summary" ]; then
                echo "$formatted_summary"
              fi
            fi
          else
            echo "‚ö†Ô∏è Plaid sync failed with status $http_code, continuing anyway"
            echo "Response: $body"
            # Don't fail workflow - snapshot can still use yesterday's transactions
          fi

      - name: Fetch closing prices
        run: |
          echo "üí∞ Fetching closing prices from Finnhub (forced)..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://401k.mreedon.com/api/prices/refresh \
            -H "X-401K-Token: ${{ secrets.API_SHARED_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"force": true}')

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -ne 200 ]; then
            echo "‚ùå Price fetch failed with status $http_code"
            exit 1
          fi

          echo "‚úÖ Closing prices fetched successfully"

      - name: Wait for database to settle
        run: |
          echo "‚è≥ Waiting 5 seconds for prices to propagate..."
          sleep 5

      - name: Create daily portfolio snapshot
        run: |
          echo "üì∏ Creating portfolio snapshot..."

          # Build request body
          if [ -n "${{ github.event.inputs.date }}" ]; then
            body='{"date": "${{ github.event.inputs.date }}", "source": "github-actions"}'
          else
            body='{"source": "github-actions"}'
          fi

          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://401k.mreedon.com/api/snapshots/save \
            -H "X-401K-Token: ${{ secrets.API_SHARED_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$body")

          http_code=$(echo "$response" | tail -n1)
          body_response=$(echo "$response" | head -n-1)

          echo "Response: $body_response"
          echo "HTTP Status: $http_code"

          # Check if successful (200) or already exists (409)
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Snapshot created successfully"
            echo "$body_response" | jq -r '.snapshot | "Date: \(.date)\nMarket Value: $\(.marketValue)\nGain/Loss: $\(.gainLoss) (\(.gainLossPercent)%)\nHoldings: \(.holdingsCount)"'
          elif [ "$http_code" -eq 409 ]; then
            echo "‚ÑπÔ∏è Snapshot already exists for today"
          else
            echo "‚ùå Snapshot creation failed with status $http_code"
            exit 1
          fi
